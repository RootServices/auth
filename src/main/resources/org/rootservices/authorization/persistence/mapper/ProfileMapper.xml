<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.rootservices.authorization.persistence.mapper.ProfileMapper">

    <resultMap id="profile" type="org.rootservices.authorization.persistence.entity.Profile">
        <id column="id" property="id" javaType="java.util.UUID" jdbcType="OTHER" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.UUIDTypeHandler"/>

        <result column="name" property="name" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="middle_name" property="middleName" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="nick_name" property="nickName" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="preferred_user_name" property="preferredUserName" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="profile" property="profile" jdbcType="VARCHAR" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler"/>
        <result column="picture" property="picture" jdbcType="VARCHAR" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler"/>
        <result column="website" property="website" jdbcType="VARCHAR" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler"/>
        <result column="gender" property="gender" javaType="org.rootservices.authorization.persistence.entity.Gender" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalEnumTypeHandler"/>
        <result column="birth_date" property="birthDate" javaType="java.time.OffsetDateTime" jdbcType="DATE" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalOffsetDateTimeTypeHandler"/>
        <result column="zone_info" property="zoneInfo" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="locale" property="locale" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="phone_number" property="phoneNumber" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler"/>
        <result column="phone_number_verified" property="phoneNumberVerified" />
        <result column="created_at" property="createdAt" javaType="java.time.OffsetDateTime" jdbcType="DATE" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OffsetDateTimeTypeHandler"/>
        <result column="updated_at" property="updatedAt" javaType="java.time.OffsetDateTime" jdbcType="DATE" typeHandler="org.rootservices.authorization.persistence.mapper.typehandler.OffsetDateTimeTypeHandler"/>

        <association property="resourceOwner"
                     resultMap="org.rootservices.authorization.persistence.mapper.ResourceOwnerMapper.resourceOwner"
                     columnPrefix="ro_"/>
        <association property="addresses"
                     resultMap="org.rootservices.authorization.persistence.mapper.AddressMapper.address"
                     columnPrefix="address_"/>
        <association property="givenNames"
                     resultMap="org.rootservices.authorization.persistence.mapper.GivenNameMapper.givenName"
                     columnPrefix="given_name_"/>
        <association property="familyNames"
                     resultMap="org.rootservices.authorization.persistence.mapper.FamilyNameMapper.familyName"
                     columnPrefix="family_name_"/>
    </resultMap>

    <insert id="insert">
        insert into resource_owner_profile
        (
            id,
            resource_owner_id,
            name,
            middle_name,
            nick_name,
            preferred_user_name,
            profile,
            picture,
            website,
            gender,
            birth_date,
            zone_info,
            locale,
            phone_number,
            phone_number_verified
        )
        values (
            #{profile.id},
            #{profile.resourceOwner.uuid},
            #{profile.name, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.middleName, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.nickName, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.preferredUserName, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.profile, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler},
            #{profile.picture, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler},
            #{profile.website, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalURITypeHandler},
            #{profile.gender, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalEnumTypeHandler},
            #{profile.birthDate, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalOffsetDateTimeTypeHandler},
            #{profile.zoneInfo, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.locale, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.phoneNumber, typeHandler=org.rootservices.authorization.persistence.mapper.typehandler.OptionalStringTypeHandler},
            #{profile.phoneNumberVerified}
        )
    </insert>

    <select id="getById" resultMap="profile">
        select
            profile.id,
            profile.name,
            profile.middle_name,
            profile.nick_name,
            profile.preferred_user_name,
            profile.profile,
            profile.picture,
            profile.website,
            profile.gender,
            profile.birth_date,
            profile.zone_info,
            profile.locale,
            profile.phone_number,
            profile.phone_number_verified,
            profile.updated_at,
            profile.created_at,
            ro.id as ro_id,
            ro.email as ro_email,
            ro.password as ro_password,
            ro.email_verified as ro_email_verified,
            ro.created_at as ro_created_at
        from resource_owner_profile as profile
        join resource_owner ro on ro.id=profile.resource_owner_id
        where profile.id = #{id}
    </select>

    <select id="getByResourceId" resultMap="profile">
        select
            profile.id,
            profile.resource_owner_id,
            profile.name,
            profile.middle_name,
            profile.nick_name,
            profile.preferred_user_name,
            profile.profile,
            profile.picture,
            profile.website,
            profile.gender,
            profile.birth_date,
            profile.zone_info,
            profile.locale,
            profile.phone_number,
            profile.phone_number_verified,
            profile.updated_at,
            profile.created_at,
            ro.id as ro_id,
            ro.email as ro_email,
            ro.password as ro_password,
            ro.email_verified as ro_email_verified,
            ro.created_at as ro_created_at,
            address.id as address_id,
            address.resource_owner_profile_id as address_resource_owner_profile_id,
            address.street_address as address_street_address,
            address.street_address2 as address_street_address2,
            address.locality as address_locality,
            address.region as address_region,
            address.postal_code as address_postal_code,
            address.country as address_country,
            address.updated_at as address_updated_at,
            address.created_at as address_created_at,
            given_name.id as given_name_id,
            given_name.resource_owner_profile_id as given_name_resource_owner_profile_id,
            given_name.given_name as given_name_given_name,
            given_name.created_at as given_name_created_at,
            given_name.updated_at as given_name_updated_at,
            family_name.id as family_name_id,
            family_name.resource_owner_profile_id as family_name_resource_owner_profile_id,
            family_name.family_name as family_name_family_name,
            family_name.created_at as family_name_created_at,
            family_name.updated_at as family_name_updated_at
        from resource_owner_profile as profile
        join resource_owner ro on ro.id=profile.resource_owner_id
        left join resource_owner_profile_address address on address.resource_owner_profile_id = profile.id
        left join resource_owner_profile_given_name given_name on given_name.resource_owner_profile_id = profile.id
        left join resource_owner_profile_family_name family_name on family_name.resource_owner_profile_id = profile.id
        where ro.id = #{resourceOwnerId}
    </select>
</mapper>
